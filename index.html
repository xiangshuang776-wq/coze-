<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>VideoFlow | AI è§†é¢‘ç”ŸæˆåŠ©æ‰‹</title>
    <style>
        :root { --primary: #8B5CF6; --bg: #050507; --card: rgba(17, 17, 22, 0.9); --border: rgba(139, 92, 246, 0.3); }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; align-items: center; justify-content: center; font-family: -apple-system, sans-serif; color: white; }
        .app-container { width: 900px; height: 550px; background: var(--card); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 24px; display: flex; box-shadow: 0 0 50px rgba(139, 92, 246, 0.15); overflow: hidden; }
        .controls { width: 350px; padding: 40px; border-right: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; }
        textarea { flex: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 12px; padding: 15px; color: white; resize: none; outline: none; margin-bottom: 20px; font-size: 14px; line-height: 1.6; }
        textarea:focus { border-color: var(--primary); }
        .btn-gen { background: var(--primary); border: none; padding: 16px; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 16px; }
        .btn-gen:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-gen:disabled { background: #444; cursor: not-allowed; transform: none; }
        .preview { flex: 1; padding: 40px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(139, 92, 246, 0.02); }
        .video-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 16px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        #statusText { margin-top: 20px; font-size: 13px; color: #888; text-align: center; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        video { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="controls">
        <h1 style="margin: 0 0 10px 0; font-size: 24px; color: var(--primary);">VideoFlow</h1>
        <p style="color: #666; font-size: 13px; margin-bottom: 30px;">è¾“å…¥ä¸»é¢˜ï¼ŒAI è‡ªåŠ¨ç”Ÿæˆè§†é¢‘æ–¹æ¡ˆ</p>
        <textarea id="promptInput" placeholder="è¯·è¾“å…¥è§†é¢‘ä¸»é¢˜ï¼ˆä¾‹å¦‚ï¼š2026å¹´å±è™äººçš„å…¨æ–¹ä½è¿åŠ¿è§£æï¼‰"></textarea>
        <button class="btn-gen" id="runBtn" onclick="runTask()">ç«‹å³ç”Ÿæˆè§†é¢‘</button>
    </div>
    <div class="preview">
        <div class="video-box">
            <div class="loader" id="loader"></div>
            <video id="outputVideo" style="display:none;" controls autoplay></video>
            <div id="placeholder" style="color:#333; text-align: center;">
                <p style="font-size: 40px; margin: 0;">ğŸ¬</p>
                <p style="font-size: 12px;">ç­‰å¾…ç”Ÿæˆé¢„è§ˆ</p>
            </div>
        </div>
        <div id="statusText">ç³»ç»Ÿå°±ç»ªï¼Œè¯·å½•å…¥æç¤ºè¯</div>
    </div>
</div>

<script>
    async function runTask() {
        const prompt = document.getElementById('promptInput').value;
        const btn = document.getElementById('runBtn');
        const status = document.getElementById('statusText');
        const loader = document.getElementById('loader');
        const video = document.getElementById('outputVideo');
        const placeholder = document.getElementById('placeholder');

        if (!prompt) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");

        // çŠ¶æ€åˆå§‹åŒ–
        btn.disabled = true;
        loader.style.display = "block";
        video.style.display = "none";
        placeholder.style.display = "none";
        status.innerText = "æ­£åœ¨è¿æ¥æ‰£å­å·¥ä½œæµï¼Œè¯·ç¨å (çº¦60ç§’)...";

        try {
            const response = await fetch('/api/run', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IjIwYjMzZDE1LTBhZTEtNDQyZC1iMmNhLTc2YzFjZjg3MWY5NyJ9.eyJpc3MiOiJodHRwczovL2FwaS5jb3plLmNuIiwiYXVkIjpbIlRROFNZdndtYlNpa0M5Rml2cGVYMjlrbHpnejNLc0FDIl0sImV4cCI6ODIxMDI2Njg3Njc5OSwiaWF0IjoxNzY5NTg4ODgyLCJzdWIiOiJzcGlmZmU6Ly9hcGkuY296ZS5jbi93b3JrbG9hZF9pZGVudGl0eS9pZDo3NTk4ODQ1NTQ5OTE1MTQ0MjExIiwic3JjIjoiaW5ib3VuZF9hdXRoX2FjY2Vzc190b2tlbl9pZDo3NjAwMzI2Mzc5NjgyMzk4MjcxIn0.kTwhqvw4n99RDDs96uyEL8vc7VfrAlbTkYGsxCA-S95YbZLDhNNBvPBXaaLU7X8NGH3ecDK3NJvp1x0VqxkQ_mByQPB9Me3OSqpDyIFfcu0XrzrJRKywDxe3Z2foGGNNp4JS-202cZ2VM9jwZjyucgSWhk1Id0P8WBFcZ9A3wQq5eiEMSIiLjQ1ffQA9lKlSuarZj8W8HC8jJhuxJAgWBFq4Z-fNM2g9iqp6Se1ubxv395XT6GgY5YzqcscdwjJmf4CAW2hKpyOu3kBJJja_bbPcemH3cgZCAe2aGyk0pXBI2ZCcv56zRaSCfBVS6XcjpiMs_KCjavbP8Jg3m7tgog',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "topic": prompt })
            });

            const result = await response.json();
            console.log("Coze Response:", result);

            // --- æš´åŠ›å…¼å®¹æœç´¢é€»è¾‘ ---
            let finalUrl = "";
            
            // æ·±åº¦ä¼˜å…ˆæœç´¢æ‰€æœ‰é”®å€¼å¯¹ï¼Œå¯»æ‰¾ mp4 æˆ– http åœ°å€
            function deepSearch(obj) {
                if (finalUrl) return;
                for (let key in obj) {
                    let val = obj[key];
                    if (typeof val === 'string' && val.startsWith('http') && (val.includes('.mp4') || val.includes('video'))) {
                        finalUrl = val;
                        return;
                    }
                    if (typeof val === 'object' && val !== null) deepSearch(val);
                }
            }
            deepSearch(result);

            if (finalUrl) {
                video.src = finalUrl;
                video.style.display = "block";
                status.innerText = "âœ¨ è§†é¢‘ç”ŸæˆæˆåŠŸï¼";
            } else {
                status.innerText = "æ•°æ®å·²è¿”å›ä½†æœªæ‰¾åˆ°è§†é¢‘ï¼Œè¯·æ£€æŸ¥å·¥ä½œæµè¾“å‡ºå˜é‡ã€‚";
                console.error("No URL found in:", result);
                placeholder.style.display = "block";
            }

        } catch (err) {
            status.innerText = "å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ Netlify è½¬å‘è®¾ç½®æˆ– Tokenã€‚";
            placeholder.style.display = "block";
        } finally {
            btn.disabled = false;
            loader.style.display = "none";
        }
    }
</script>

</body>
</html>
